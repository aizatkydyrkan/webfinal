<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bistro OS | Premium Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="min-h-screen">
    <header class="p-6 border-b border-white/5 bg-slate-900/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-black tracking-tighter italic">BISTRO<span class="text-indigo-400">OS</span></h1>
            <div class="glass px-6 py-2 rounded-full flex items-center gap-3 text-sm">
                <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                Available Seats: <span id="seats-val" class="font-bold text-indigo-300">...</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Форма бронирования -->
        <div class="lg:col-span-7">
            <div class="glass p-8 rounded-[2rem]">
                <h2 class="text-3xl font-bold mb-8">Book a Table</h2>
                <form id="bookForm" class="space-y-6">
                    <input type="text" id="gName" required placeholder="Guest Name" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="time" id="gTime" required class="bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="number" id="gCount" min="1" max="12" required placeholder="Guests" class="bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 py-5 rounded-2xl font-bold transition">Confirm Reservation</button>
                </form>
            </div>
        </div>

        <!-- Админка -->
        <div class="lg:col-span-5">
            <div id="adminLogin" class="glass p-8 rounded-[2rem]">
                <h3 class="text-xl font-bold mb-6 italic">Admin Access</h3>
                <div class="space-y-4">
                    <input type="text" id="aUser" placeholder="Username" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none">
                    <input type="password" id="aPass" placeholder="Password" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none">
                    <button onclick="handleLogin()" class="w-full bg-white text-slate-900 font-bold py-4 rounded-2xl hover:bg-indigo-50 transition">Authorize</button>
                </div>
            </div>

            <div id="adminPanel" class="hidden glass p-6 rounded-[2rem]">
                <div class="flex justify-between mb-6">
                    <h3 class="font-bold text-xl">Active Logs</h3>
                    <button onclick="logout()" class="text-xs text-red-400 font-bold uppercase">Sign Out</button>
                </div>
                <div id="bookingList" class="space-y-3 max-h-[400px] overflow-y-auto"></div>
            </div>
        </div>
    </main>

    <script>
        const API = '/api';

        // Обновление счетчика мест
        async function updateUI() {
            try {
                const res = await fetch(`${API}/res/status`);
                const data = await res.json();
                document.getElementById('seats-val').innerText = data.available;
            } catch (e) { console.log("Status error"); }
        }

        // Бронирование
        document.getElementById('bookForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await fetch(`${API}/res/create`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    guestName: document.getElementById('gName').value,
                    time: document.getElementById('gTime').value,
                    peopleCount: parseInt(document.getElementById('gCount').value)
                })
            });
            const data = await res.json();
            alert(data.message || data.error);
            if(res.ok) { 
                e.target.reset(); 
                updateUI(); 
                if(localStorage.getItem('token')) loadAdminData(); 
            }
        };

        // Логин
        async function handleLogin() {
            const res = await fetch(`${API}/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: document.getElementById('aUser').value, 
                    password: document.getElementById('aPass').value
                })
            });
            const data = await res.json();
            if(data.token) {
                localStorage.setItem('token', data.token);
                showAdmin();
            } else { alert(data.error || "Login failed"); }
        }

        async function loadAdminData() {
    const token = localStorage.getItem('token');
    const res = await fetch(`${API}/res/list`, {
        headers: {'Authorization': `Bearer ${token}`}
    });
    if(res.status === 401) return logout();
    const list = await res.json();
    
    document.getElementById('bookingList').innerHTML = list.map(item => `
        <div class="p-4 bg-white/5 border border-white/5 rounded-2xl flex justify-between items-center group">
            <div>
                <div class="font-bold text-white">${item.guestName}</div>
                <div class="flex gap-4 text-xs text-slate-500 mt-2">
                    <span><i class="far fa-clock text-indigo-400"></i> ${item.time}</span>
                    <span><i class="fas fa-users text-indigo-400"></i> ${item.peopleCount} PAX</span>
                </div>
            </div>
            <button onclick="deleteBooking('${item._id}')" class="text-slate-500 hover:text-red-500 transition-colors p-2">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    `).join('');
}

async function deleteBooking(id) {
    if(!confirm("Are you sure you want to delete this reservation?")) return;

    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`${API}/res/delete/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        const data = await res.json();
        
        if (res.ok) {
            loadAdminData(); // Обновляем список
            updateUI();      // Обновляем количество свободных мест
        } else {
            alert(data.error || "Failed to delete");
        }
    } catch (e) {
        console.error("Delete error:", e);
    }
}

        function showAdmin() {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            loadAdminData();
        }

        function logout() { localStorage.removeItem('token'); location.reload(); }

        updateUI();
        if(localStorage.getItem('token')) showAdmin();
    </script>
</body>
</html>